---
export const prerender = false;

import AppLayout from '../../../layouts/AppLayout.astro';
import Badge from '../../../components/ui/Badge.astro';
import { getMissions } from '../../../lib/db';

const user = Astro.locals.user!;
const missions = getMissions();

const today = new Date();
const upcomingMissions = missions.filter(m => m.status === 'PLANNED' || m.status === 'BRIEFING');
const inProgressMissions = missions.filter(m => m.status === 'IN_PROGRESS');

const statusLabels: Record<string, string> = {
  PLANNED: 'Planifiée',
  BRIEFING: 'Briefing',
  IN_PROGRESS: 'En cours',
  COMPLETED: 'Terminée',
  CANCELLED: 'Annulée'
};

const statusVariants: Record<string, 'success' | 'warning' | 'error' | 'info' | 'default'> = {
  PLANNED: 'default',
  BRIEFING: 'warning',
  IN_PROGRESS: 'info',
  COMPLETED: 'success',
  CANCELLED: 'error'
};

const typeLabels: Record<string, string> = {
  INTERVENTION: 'Intervention',
  SURVEILLANCE: 'Surveillance',
  ESCORT: 'Escorte',
  TRAINING: 'Entraînement',
  PATROL: 'Patrouille'
};

function formatDate(date: Date) {
  return new Intl.DateTimeFormat('fr-FR', {
    weekday: 'short',
    day: 'numeric',
    month: 'short',
    hour: '2-digit',
    minute: '2-digit'
  }).format(new Date(date));
}
---
<AppLayout title="Planning" user={user}>
  <div class="planning-page">
    <div class="page-header">
      <div class="page-header__content">
        <h1 class="page-title">Planning</h1>
        <p class="page-subtitle">Vue d'ensemble des missions</p>
      </div>
      <a href="/app/missions/new" class="btn-primary">+ Nouvelle mission</a>
    </div>

    {inProgressMissions.length > 0 && (
      <div class="section">
        <h2 class="section__title">En cours</h2>
        <div class="missions-list">
          {inProgressMissions.map(mission => (
            <a href={`/app/missions/${mission.id}`} class="mission-card mission-card--active">
              <div class="mission-card__status">
                <span class="mission-card__pulse"></span>
                <Badge variant="info" size="sm">En cours</Badge>
              </div>
              <div class="mission-card__content">
                <h3 class="mission-card__name">{mission.name}</h3>
                <span class="mission-card__type">{typeLabels[mission.type]}</span>
              </div>
              <div class="mission-card__meta">
                <span class="mission-card__time">Démarré {formatDate(mission.started_at!)}</span>
              </div>
            </a>
          ))}
        </div>
      </div>
    )}

    <div class="section">
      <h2 class="section__title">À venir</h2>
      {upcomingMissions.length === 0 ? (
        <p class="empty-state">Aucune mission planifiée</p>
      ) : (
        <div class="missions-list">
          {upcomingMissions.map(mission => (
            <a href={`/app/missions/${mission.id}`} class="mission-card">
              <div class="mission-card__status">
                <Badge variant={statusVariants[mission.status]} size="sm">
                  {statusLabels[mission.status]}
                </Badge>
              </div>
              <div class="mission-card__content">
                <h3 class="mission-card__name">{mission.name}</h3>
                <span class="mission-card__type">{typeLabels[mission.type]}</span>
              </div>
              <div class="mission-card__meta">
                <span class="mission-card__time">{formatDate(mission.scheduled_at)}</span>
              </div>
            </a>
          ))}
        </div>
      )}
    </div>
  </div>
</AppLayout>

<style lang="scss">
  @use '../../../styles/variables' as *;
  @use '../../../styles/mixins' as *;

  .planning-page {
    max-width: 900px;
  }

  .page-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: $spacing-2xl;
  }

  .page-title {
    font-size: $font-size-3xl;
    font-weight: $font-weight-semibold;
    margin-bottom: $spacing-xs;
  }

  .page-subtitle {
    color: $color-text-secondary;
  }

  .btn-primary {
    display: inline-flex;
    align-items: center;
    padding: $spacing-sm $spacing-lg;
    background: $color-accent;
    color: #fff;
    font-size: $font-size-sm;
    font-weight: $font-weight-medium;
    border-radius: $radius-md;
    text-decoration: none;
    transition: background $transition-fast;

    &:hover {
      background: $color-accent-hover;
      color: #fff;
    }
  }

  .section {
    margin-bottom: $spacing-2xl;
  }

  .section__title {
    font-size: $font-size-lg;
    font-weight: $font-weight-semibold;
    margin-bottom: $spacing-lg;
    color: $color-text-secondary;
  }

  .missions-list {
    display: flex;
    flex-direction: column;
    gap: $spacing-md;
  }

  .mission-card {
    display: grid;
    grid-template-columns: auto 1fr auto;
    align-items: center;
    gap: $spacing-lg;
    background: $color-bg-card;
    border: 1px solid $color-border;
    border-radius: $radius-lg;
    padding: $spacing-lg;
    text-decoration: none;
    transition: all $transition-base;

    &:hover {
      border-color: $color-border-hover;
    }

    &--active {
      border-color: rgba($color-accent-light, 0.3);
      background: rgba($color-accent, 0.05);
    }
  }

  .mission-card__status {
    display: flex;
    align-items: center;
    gap: $spacing-sm;
  }

  .mission-card__pulse {
    width: 8px;
    height: 8px;
    background: $color-accent-light;
    border-radius: 50%;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  .mission-card__content {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .mission-card__name {
    font-size: $font-size-base;
    font-weight: $font-weight-semibold;
    color: $color-text-primary;
  }

  .mission-card__type {
    font-size: $font-size-sm;
    color: $color-text-tertiary;
  }

  .mission-card__meta {
    text-align: right;
  }

  .mission-card__time {
    font-size: $font-size-sm;
    color: $color-text-secondary;
    font-family: $font-family-mono;
  }

  .empty-state {
    color: $color-text-tertiary;
    font-style: italic;
  }
</style>
