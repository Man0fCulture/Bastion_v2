---
export const prerender = false;

import AppLayout from '../../../layouts/AppLayout.astro';
import Badge from '../../../components/ui/Badge.astro';
import { getVehicle, getVehicleLogs, getEmployees } from '../../../lib/db';

const user = Astro.locals.user!;
const { id } = Astro.params;
const vehicle = getVehicle(id!);

if (!vehicle) {
  return Astro.redirect('/app/vehicles');
}

const logs = getVehicleLogs(id!);
const employees = getEmployees();

const stateLabels: Record<string, string> = {
  AVAILABLE: 'Disponible',
  IN_USE: 'En service',
  MAINTENANCE: 'Maintenance',
  OUT_OF_SERVICE: 'Hors service'
};

const stateVariants: Record<string, 'success' | 'warning' | 'error' | 'info' | 'default'> = {
  AVAILABLE: 'success',
  IN_USE: 'info',
  MAINTENANCE: 'warning',
  OUT_OF_SERVICE: 'error'
};

const typeLabels: Record<string, string> = {
  CAR: 'Voiture',
  VAN: 'Fourgon',
  TRUCK: 'Camion',
  MOTORCYCLE: 'Moto',
  ARMORED: 'Blindé'
};

function formatDate(date: Date) {
  return new Intl.DateTimeFormat('fr-FR', {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  }).format(new Date(date));
}

function formatDateTime(date: Date) {
  return new Intl.DateTimeFormat('fr-FR', {
    day: 'numeric',
    month: 'short',
    hour: '2-digit',
    minute: '2-digit'
  }).format(new Date(date));
}
---
<AppLayout title={vehicle.name} user={user}>
  <div class="vehicle-detail">
    <div class="page-header">
      <a href="/app/vehicles" class="back-link">
        <svg viewBox="0 0 24 24" class="back-link__icon">
          <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        </svg>
        Retour aux véhicules
      </a>
    </div>

    <div class="detail-grid">
      <div class="main-section">
        <div class="detail-card">
          <div class="detail-card__header">
            <div class="detail-card__title-row">
              <span class="detail-card__type">{typeLabels[vehicle.type]}</span>
              <Badge variant={stateVariants[vehicle.state]} size="sm">
                {stateLabels[vehicle.state]}
              </Badge>
            </div>
            <h1 class="detail-card__title">{vehicle.name}</h1>
            <span class="detail-card__registration">{vehicle.registration}</span>
          </div>

          {vehicle.description && (
            <div class="detail-card__description">
              <p>{vehicle.description}</p>
            </div>
          )}

          <div class="detail-card__specs">
            <div class="spec-item">
              <span class="spec-item__label">Kilométrage</span>
              <span class="spec-item__value">{vehicle.mileage.toLocaleString()} km</span>
            </div>
            <div class="spec-item">
              <span class="spec-item__label">Dernière maintenance</span>
              <span class="spec-item__value">{vehicle.last_maintenance ? formatDate(vehicle.last_maintenance) : '-'}</span>
            </div>
            <div class="spec-item">
              <span class="spec-item__label">Prochaine maintenance</span>
              <span class="spec-item__value">{vehicle.next_maintenance ? formatDate(vehicle.next_maintenance) : '-'}</span>
            </div>
            <div class="spec-item">
              <span class="spec-item__label">Antenne</span>
              <span class="spec-item__value">{vehicle.store?.name || '-'}</span>
            </div>
          </div>
        </div>

        {vehicle.photos && vehicle.photos.length > 0 && (
          <div class="detail-card">
            <h2 class="detail-card__section-title">Photos</h2>
            <div class="photos-grid">
              {vehicle.photos.map(photo => (
                <div class="photo-placeholder">
                  <span class="photo-placeholder__icon">
                  <svg viewBox="0 0 24 24" class="photo-placeholder__svg">
                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" stroke="currentColor" stroke-width="2" fill="none"/>
                    <circle cx="12" cy="13" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
                  </svg>
                </span>
                  <span class="photo-placeholder__text">{photo.storage_key}</span>
                </div>
              ))}
            </div>
          </div>
        )}

        {logs.length > 0 && (
          <div class="detail-card">
            <h2 class="detail-card__section-title">Historique d'utilisation</h2>
            <div class="logs-table">
              <div class="logs-table__header">
                <span>Opérateur</span>
                <span>Début</span>
                <span>Fin</span>
                <span>Km</span>
              </div>
              {logs.map(log => {
                const operator = employees.find(e => e.id === log.operator_id);
                return (
                  <div class="logs-table__row">
                    <span class="logs-table__operator">
                      {operator ? `${operator.firstname} ${operator.lastname}` : '-'}
                    </span>
                    <span class="logs-table__date">{formatDateTime(log.started_at)}</span>
                    <span class="logs-table__date">{log.ended_at ? formatDateTime(log.ended_at) : 'En cours'}</span>
                    <span class="logs-table__km">
                      {log.mileage_end ? `${log.mileage_end - log.mileage_start} km` : '-'}
                    </span>
                  </div>
                );
              })}
            </div>
          </div>
        )}
      </div>

      <div class="side-section">
        <div class="detail-card">
          <h2 class="detail-card__section-title">Assignation</h2>
          {vehicle.assigned_to ? (
            <a href={`/app/employees/${vehicle.assigned_to.id}`} class="assignee-card">
              <div class="assignee-card__avatar">
                {vehicle.assigned_to.firstname.charAt(0)}{vehicle.assigned_to.lastname.charAt(0)}
              </div>
              <div class="assignee-card__info">
                <span class="assignee-card__name">{vehicle.assigned_to.firstname} {vehicle.assigned_to.lastname}</span>
                <span class="assignee-card__detail">{vehicle.assigned_to.indicatif} · {vehicle.assigned_to.matricule}</span>
              </div>
            </a>
          ) : (
            <p class="no-assignment">Non assigné</p>
          )}
        </div>

        <div class="detail-card">
          <h2 class="detail-card__section-title">Actions</h2>
          <div class="actions-list">
            {vehicle.state === 'AVAILABLE' && (
              <button class="action-btn action-btn--primary">Prendre le véhicule</button>
            )}
            {vehicle.state === 'IN_USE' && (
              <button class="action-btn action-btn--primary">Retourner le véhicule</button>
            )}
            <button class="action-btn">Modifier</button>
            <button class="action-btn">Ajouter photo</button>
            {vehicle.state !== 'MAINTENANCE' && (
              <button class="action-btn action-btn--warning">Envoyer en maintenance</button>
            )}
          </div>
        </div>

        <div class="detail-card">
          <h2 class="detail-card__section-title">Informations</h2>
          <div class="info-list">
            <div class="info-item">
              <span class="info-item__label">Immatriculation</span>
              <span class="info-item__value">{vehicle.registration}</span>
            </div>
            <div class="info-item">
              <span class="info-item__label">Type</span>
              <span class="info-item__value">{typeLabels[vehicle.type]}</span>
            </div>
            <div class="info-item">
              <span class="info-item__label">Antenne</span>
              <span class="info-item__value">{vehicle.store?.name || '-'}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</AppLayout>

<style lang="scss">
  @use '../../../styles/variables' as *;
  @use '../../../styles/mixins' as *;

  .vehicle-detail {
    max-width: 1200px;
  }

  .page-header {
    margin-bottom: $spacing-xl;
  }

  .back-link {
    color: $color-text-secondary;
    text-decoration: none;
    font-size: $font-size-sm;
    display: inline-flex;
    align-items: center;
    gap: $spacing-xs;
    transition: color $transition-fast;

    &:hover {
      color: $color-text-primary;
    }
  }

  .back-link__icon {
    width: 16px;
    height: 16px;
    transition: transform $transition-fast;

    .back-link:hover & {
      transform: translateX(-3px);
    }
  }

  .detail-grid {
    display: grid;
    grid-template-columns: 1fr 360px;
    gap: $spacing-xl;

    @media (max-width: 900px) {
      grid-template-columns: 1fr;
    }
  }

  .main-section, .side-section {
    display: flex;
    flex-direction: column;
    gap: $spacing-xl;
  }

  .detail-card {
    background: $color-bg-card;
    border: 1px solid $color-border;
    border-radius: $radius-lg;
    padding: $spacing-xl;
  }

  .detail-card__header {
    margin-bottom: $spacing-xl;
  }

  .detail-card__title-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: $spacing-sm;
  }

  .detail-card__type {
    font-size: $font-size-xs;
    color: $color-text-tertiary;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .detail-card__title {
    font-size: $font-size-2xl;
    font-weight: $font-weight-bold;
    margin-bottom: $spacing-xs;
  }

  .detail-card__registration {
    font-size: $font-size-lg;
    color: $color-accent;
    font-family: $font-family-mono;
    font-weight: $font-weight-semibold;
  }

  .detail-card__description {
    margin-bottom: $spacing-xl;
    padding: $spacing-lg;
    background: rgba(255, 255, 255, 0.02);
    border-radius: $radius-md;

    p {
      color: $color-text-secondary;
      line-height: 1.6;
    }
  }

  .detail-card__section-title {
    font-size: $font-size-sm;
    font-weight: $font-weight-semibold;
    color: $color-text-secondary;
    margin-bottom: $spacing-lg;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .detail-card__specs {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: $spacing-lg;
  }

  .spec-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .spec-item__label {
    font-size: $font-size-xs;
    color: $color-text-tertiary;
  }

  .spec-item__value {
    font-size: $font-size-base;
    color: $color-text-primary;
    font-family: $font-family-mono;
  }

  .photos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: $spacing-md;
  }

  .photo-placeholder {
    aspect-ratio: 4/3;
    background: rgba(255, 255, 255, 0.02);
    border: 1px dashed $color-border;
    border-radius: $radius-md;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: $spacing-sm;
  }

  .photo-placeholder__icon {
    display: flex;
    align-items: center;
    justify-content: center;
    color: $color-text-tertiary;
    opacity: 0.5;
  }

  .photo-placeholder__svg {
    width: 32px;
    height: 32px;
  }

  .photo-placeholder__text {
    font-size: $font-size-xs;
    color: $color-text-tertiary;
    text-align: center;
    padding: 0 $spacing-sm;
    word-break: break-all;
  }

  .logs-table {
    display: flex;
    flex-direction: column;
  }

  .logs-table__header {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 80px;
    gap: $spacing-md;
    padding: $spacing-sm 0;
    border-bottom: 1px solid $color-border;
    font-size: $font-size-xs;
    color: $color-text-tertiary;
    text-transform: uppercase;
  }

  .logs-table__row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 80px;
    gap: $spacing-md;
    padding: $spacing-md 0;
    border-bottom: 1px solid $color-border;
    font-size: $font-size-sm;

    &:last-child {
      border-bottom: none;
    }
  }

  .logs-table__operator {
    color: $color-text-primary;
  }

  .logs-table__date {
    color: $color-text-secondary;
    font-family: $font-family-mono;
    font-size: $font-size-xs;
  }

  .logs-table__km {
    color: $color-accent;
    font-family: $font-family-mono;
  }

  .assignee-card {
    display: flex;
    align-items: center;
    gap: $spacing-md;
    padding: $spacing-md;
    background: rgba(255, 255, 255, 0.02);
    border-radius: $radius-md;
    text-decoration: none;
    transition: background $transition-fast;

    &:hover {
      background: rgba(255, 255, 255, 0.05);
    }
  }

  .assignee-card__avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: linear-gradient(135deg, $color-accent 0%, $color-accent-light 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: $font-size-sm;
    font-weight: $font-weight-semibold;
    color: #fff;
    flex-shrink: 0;
  }

  .assignee-card__info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .assignee-card__name {
    font-size: $font-size-base;
    font-weight: $font-weight-medium;
    color: $color-text-primary;
  }

  .assignee-card__detail {
    font-size: $font-size-sm;
    color: $color-text-tertiary;
    font-family: $font-family-mono;
  }

  .no-assignment {
    color: $color-text-tertiary;
    font-style: italic;
  }

  .actions-list {
    display: flex;
    flex-direction: column;
    gap: $spacing-sm;
  }

  .action-btn {
    width: 100%;
    padding: $spacing-md;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid $color-border;
    border-radius: $radius-md;
    color: $color-text-secondary;
    font-size: $font-size-sm;
    font-weight: $font-weight-medium;
    cursor: pointer;
    transition: all $transition-fast;

    &:hover {
      background: rgba(255, 255, 255, 0.06);
      color: $color-text-primary;
    }

    &--primary {
      background: $color-accent;
      border-color: $color-accent;
      color: #fff;

      &:hover {
        background: $color-accent-hover;
      }
    }

    &--warning {
      color: $color-warning;
      border-color: rgba($color-warning, 0.3);

      &:hover {
        background: rgba($color-warning, 0.1);
      }
    }
  }

  .info-list {
    display: flex;
    flex-direction: column;
    gap: $spacing-md;
  }

  .info-item {
    display: flex;
    justify-content: space-between;
    padding: $spacing-sm 0;
    border-bottom: 1px solid $color-border;

    &:last-child {
      border-bottom: none;
    }
  }

  .info-item__label {
    font-size: $font-size-sm;
    color: $color-text-tertiary;
  }

  .info-item__value {
    font-size: $font-size-sm;
    color: $color-text-primary;
    font-family: $font-family-mono;
  }
</style>
