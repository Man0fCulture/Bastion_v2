---
import type { User } from '../lib/types';
import { ViewTransitions } from 'astro:transitions';

interface Props {
  title: string;
  user: User;
}

const { title, user } = Astro.props;

const navItems = [
  { label: 'Command Center', href: '/app', exact: true },
  { label: 'Ã‰quipements', href: '/app/assets' },
  { label: 'Demandes', href: '/app/claims', role: 'MANAGER' }, // Assuming logic: != EMPLOYEE means MANAGER/ADMIN usually? Or simplified check
  { label: 'Agents', href: '/app/employees' },
  { label: 'Antennes', href: '/app/stores', role: 'ADMIN' },
];

function isActive(href: string, exact = false) {
  const currentPath = Astro.url.pathname;
  if (exact) {
    return currentPath === href || currentPath === href + '/';
  }
  return currentPath.startsWith(href);
}
---
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <title>{title} | Bastion</title>
  <ViewTransitions />
</head>
<body>
  <div class="app-layout">
    <aside class="app-sidebar">
      <div class="app-sidebar__header">
        <a href="/app" class="app-sidebar__logo">Bastion</a>
      </div>
      <nav class="app-sidebar__nav">
        {navItems.map(item => {
          if (item.role === 'ADMIN' && user.role !== 'ADMIN') return null;
          if (item.role === 'MANAGER' && user.role === 'EMPLOYEE') return null;
          
          const active = isActive(item.href, item.exact);
          return (
            <a href={item.href} class:list={["app-sidebar__link", { active }]}>
              {active && (
                <div class="active-pill-bg" transition:name="sidebar-pill"></div>
              )}
              <span class="link-text">{item.label}</span>
            </a>
          );
        })}
      </nav>
      <div class="app-sidebar__footer">
        <div class="app-sidebar__user">
          <span class="app-sidebar__user-email">{user.email}</span>
          <span class="app-sidebar__user-role">{user.role}</span>
        </div>
      </div>
    </aside>
    <main class="app-main" transition:animate="fade">
      <slot />
    </main>
  </div>
</body>
</html>


<style lang="scss" is:global>
  @use '../styles/global.scss';
</style>

<style lang="scss">
  @use '../styles/variables' as *;
  @use '../styles/mixins' as *;

  .app-layout {
    display: flex;
    min-height: 100vh;
    padding: $spacing-md;
    gap: $spacing-md;
  }

  .app-sidebar {
    width: 280px;
    @include glass-panel;
    border-radius: $radius-xl;
    display: flex;
    flex-direction: column;
    position: sticky;
    top: $spacing-md;
    height: calc(100vh - #{$spacing-md * 2});
    z-index: $z-sticky;
    transition: all $transition-base;
  }

  .app-sidebar__header {
    padding: $spacing-xl $spacing-lg;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  }

  .app-sidebar__logo {
    font-family: $font-family-heading;
    font-size: $font-size-2xl;
    font-weight: $font-weight-bold;
    @include text-royal; // Blue gradation
    text-decoration: none;
    letter-spacing: -0.02em;
    text-transform: uppercase;
  }

  .app-sidebar__nav {
    flex: 1;
    padding: $spacing-lg;
    display: flex;
    flex-direction: column;
    gap: 4px; // Spacing for pills
    overflow-y: auto;
  }

  .app-sidebar__link {
    display: flex;
    align-items: center;
    padding: $spacing-md $spacing-lg;
    color: $color-text-secondary;
    text-decoration: none;
    font-size: $font-size-sm;
    font-weight: $font-weight-medium;
    transition: color $transition-base; // Only transition color, bg handled by element
    border-radius: 9999px;
    position: relative; // Context for absolute bg
    isolate: isolate; // Ensure z-index works

    &:hover {
      color: $color-text-primary;
      // Subtle background for hover (not the active pill)
      &::after {
        content: '';
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 9999px;
        z-index: -2;
      }
    }

    &.active {
      color: #fff;
      font-weight: $font-weight-semibold;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
  }

  // The Sliding "Water Drop" Background
  .active-pill-bg {
    position: absolute;
    inset: 0;
    border-radius: 9999px;
    z-index: -1; // Behind text
    
    // Enhanced "Water Drop" / Liquid Glass
    background: linear-gradient(
      180deg, 
      rgba(255, 255, 255, 0.2) 0%, 
      rgba(37, 99, 235, 0.5) 100%
    );
    backdrop-filter: blur(12px) saturate(150%); // Heavier blur + saturation
    
    box-shadow: 
      // Sharp Top Edge (Surface Tension)
      inset 0 1px 1px rgba(255, 255, 255, 0.9),
      // Soft Top Highlight (Volume)
      inset 0 2px 5px rgba(255, 255, 255, 0.3),
      // Bottom Inner Shadow (Depth)
      inset 0 -2px 5px rgba(0, 0, 0, 0.1),
      // Inner Blue Glow (Caustics)
      inset 0 0 15px rgba(37, 99, 235, 0.4),
      // Deep Drop Shadow
      0 5px 15px rgba(0, 0, 0, 0.5),
      // Outer Ambient Glow
      0 0 20px rgba(37, 99, 235, 0.3);
      
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-bottom: 1px solid rgba(255, 255, 255, 0.05); // Fainter bottom border
  }
  
  .link-text {
    position: relative;
    z-index: 2;
  }

  .app-sidebar__footer {
    padding: $spacing-lg;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
    background: rgba(0, 0, 0, 0.2);
    border-bottom-left-radius: $radius-xl;
    border-bottom-right-radius: $radius-xl;
  }

  .app-sidebar__user {
    display: flex;
    flex-direction: column;
    gap: 4px;
    padding: $spacing-sm;
    border-radius: $radius-lg;
    transition: background $transition-fast;

    &:hover {
      background: rgba(255, 255, 255, 0.05);
    }
  }

  .app-sidebar__user-email {
    font-size: $font-size-sm;
    color: $color-text-primary;
    font-weight: $font-weight-medium;
    @include truncate;
  }

  .app-sidebar__user-role {
    font-size: $font-size-xs;
    color: $color-accent;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    font-weight: $font-weight-bold;
  }

  .app-main {
    flex: 1;
    min-width: 0;
    border-radius: $radius-xl;
    padding: $spacing-xl;
    position: relative;
  }
</style>
